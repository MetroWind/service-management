<IfModule !cgid_module>
  LoadModule cgid_module modules/mod_cgid.so
</IfModule>
<IfModule !cgi_module>
  LoadModule cgi_module modules/mod_cgi.so
</IfModule>
<IfModule !alias_module>
  LoadModule alias_module modules/mod_alias.so
</IfModule>
<IfModule !env_module>
  LoadModule env_module modules/mod_env.so
</IfModule>
<IfModule !suexec_module>
  LoadModule suexec_module modules/mod_suexec.so
</IfModule>

<VirtualHost *:80>
    ServerName git.xeno.darksair.org
    RewriteEngine on
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,QSA,R=permanent]
</VirtualHost>
<VirtualHost *:443>
    ServerName git.xeno.darksair.org
    SSLCertificateFile /etc/letsencrypt/live/xeno.darksair.org/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/xeno.darksair.org/privkey.pem
    RewriteEngine on

    LogLevel trace1

    DocumentRoot /srv/http-git
    SuexecUserGroup gitolite gitolite

    SetEnv GIT_PROJECT_ROOT /var/lib/gitolite/repositories/
    SetEnv GIT_HTTP_EXPORT_ALL
    SetEnvIf Git-Protocol ".*" GIT_PROTOCOL=$0
    SetEnv GITOLITE_HTTP_HOME /var/lib/gitolite

    ScriptAliasMatch \
        "(?x)^/(.*/(HEAD | \
                        info/refs | \
                        objects/(info/[^/]+ | \
                                 [0-9a-f]{2}/[0-9a-f]{38} | \
                                 pack/pack-[0-9a-f]{40}\.(pack|idx)) | \
                        git-(upload|receive)-pack))$" \
        /srv/http-git/backend-wrapper.sh/$1

    # This should go before ScriptAlias, otherwise Apache would look
    # for /statics in the CGI program.
    Alias /statics/ "/usr/share/webapps/cgit/"

    ScriptAlias / "/srv/http-git/cgit-wrapper.sh/"

    RewriteCond %{QUERY_STRING} service=git-receive-pack [OR]
    RewriteCond %{REQUEST_URI} /git-receive-pack$
    RewriteRule ^/ - [E=AUTHREQUIRED:yes]
    <LocationMatch "^/">
      Order Deny,Allow
      Deny from env=AUTHREQUIRED
      AuthType Basic
      AuthName "Git Access"
      AuthBasicProvider file
      AuthUserFile /srv/http-git/htpasswd
      Require valid-user
      Satisfy Any
    </LocationMatch>

    <Directory "/usr/share/webapps/cgit/">
      AllowOverride None
      Options None
      Require all granted
    </Directory>
    <Directory "/srv/http-git/">
      AllowOverride None
      Options ExecCGI FollowSymlinks
      Require all granted
    </Directory>
</VirtualHost>
