---
- name: Setup Clawdbot
  hosts: kosmos.xeno
  become: yes
  vars:
    openrouter_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35363239623234656361316263313261346231653564376563653966653135383164633366643135
          3835333865303132383332383861373231383039373666650a326464656566333335343361366464
          36323638656532356530386263613661616265393739316230346264393532613033343539333564
          3833633338666636610a373831346438633966666139306639373862306562343730616631323065
          36656536323837373061666339643666356265616266383635313433653133623431373530346464
          34626535633566366539386339616637346335333132323432306562343032663039326666636131
          38306534626464343437386132343465376236313966383933653764666434373132643632656238
          65663830363339376333
    tg_bot_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36653033336362336564316130613634343238363433636537356163363862633665623031343637
          3966313034636338656530303965386631396335643830640a386531643135623564326535393339
          65323165353562326665303539306634613332666434353534383866613837663166383435656231
          3431383563613134310a643461623434636134333636646234623939323566303665613064396538
          64396533653330643239643734626232393432613235346531306362633637373136363366626139
          3638616465376532393763613232393463663862313137616538
    gateway_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63326365313233643165633063353961336237636337663731316561353931623761653435633763
          3138393430303964313437613164623866386339633134360a663761623030633134383132336563
          39643133363435353632636361386535633862356662623437643038306334353263326539633539
          6463643163346364640a376361373262323066333636393263393232643438633530633333343365
          38366631623538323562376338633864356139323930346139396239613763656461336530663630
          34313764613735633334323966326539393134656230396434346230653765353736643033613331
          363238353566343364613663626263326465
    gemini_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64316433356635326465353236303165303735393637393739316532373565376430333761353863
          3830376139326335656333343961613135373532343030630a666533383931653938376263623461
          61656364643066316337636233643661633735326334633534666462373862343530373762323430
          6663623632383061310a393130333132663231313138643731613336333331333834363237623331
          33626134653362313537613863633430646534346335653336383030383438396635353339336465
          6664643834613338666634626336643534656562343861623332
  tasks:
    - name: Install deps
      community.general.pacman:
        name:
          - npm
          - go
        state: present
    - name: Copy sysusers file
      ansible.builtin.copy:
        src: clawdbot.sysusers
        dest: /usr/local/lib/sysusers.d/clawdbot.conf
        owner: root
        group: root
        mode: '0644'
    - name: Ensure user
      ansible.builtin.systemd:
        state: restarted
        name: systemd-sysusers
    - name: Create clawdbot dir
      ansible.builtin.file:
        path: /opt/clawdbot
        owner: clawdbot
        group: clawdbot
        state: directory
        mode: '0755'
    - name: Create clawdbot app dir
      ansible.builtin.file:
        path: /opt/clawdbot/clawdbot
        owner: clawdbot
        group: clawdbot
        state: directory
        mode: '0755'
    - name: Install clawdbot
      become: yes
      become_user: clawdbot
      ansible.builtin.command:
        chdir: /opt/clawdbot/clawdbot
        argv:
          - npm
          - install
          - openclaw
    - name: Link executable
      ansible.builtin.file:
        src: "/opt/clawdbot/clawdbot/node_modules/.bin/openclaw"
        dest: /usr/local/bin/openclaw
        state: link
    - name: Copy Clawdbot config
      ansible.builtin.template:
        src: config.json
        dest: /opt/clawdbot/.openclaw/openclaw.json
        owner: clawdbot
        group: clawdbot
        mode: '0600'
    - name: Copy Clawdbot service file
      ansible.builtin.copy:
        src: clawdbot.service
        dest: /etc/systemd/system/clawdbot.service
        owner: root
        group: root
        mode: '0644'
    - name: Ensure app service is enabled and started
      ansible.builtin.systemd:
        daemon_reload: yes
        state: restarted
        name: clawdbot
        enabled: yes
